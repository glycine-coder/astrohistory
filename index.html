<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarGuessr</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none;  /* Safari */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE10+ */
            user-select: none;         /* Standard */
        }
        .night-sky-container {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #0d1117;
            touch-action: none; /* Prevents default touch behavior on mobile */
        }
        .night-sky-img, .hint-img {
            transition: transform 0.1s ease-out;
            transform-origin: center center;
            will-change: transform;
            cursor: grab;
        }
        .hint-img {
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }
        .hint-img.active {
            opacity: 1;
        }
        .btn-primary {
            @apply bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-colors duration-200 ease-in-out shadow-lg;
        }
        .btn-secondary {
            @apply bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-xl transition-colors duration-200 ease-in-out shadow-lg;
        }
        .form-container.hidden {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            padding: 0;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        .form-container.visible {
            max-height: 1000px; /* フォームの高さに合わせて調整 */
            opacity: 1;
            padding: 1.5rem; /* p-6 */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 400px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <div class="container mx-auto max-w-7xl bg-gray-800 rounded-3xl shadow-2xl p-8 lg:p-12 flex flex-col gap-8 flex-grow">

        <!-- 夜空の表示エリア -->
        <div class="w-full flex flex-col items-center flex-grow">
            <h2 class="text-3xl font-bold mb-4 text-center">夜空を観察</h2>
            <div class="night-sky-container w-full aspect-video border-4 border-gray-700 flex-grow">
                <!-- デフォルト画像を新しいファイルパスに更新 -->
                <img id="night-sky-base" src="" alt="夜空の画像" class="night-sky-img w-full h-full object-cover">
                <!-- ヒント用画像は非表示で配置し、JavaScriptで切り替える -->
                <img id="night-sky-hint" src="" alt="ヒント画像" class="hint-img w-full h-full object-cover">
            </div>
            <p class="mt-4 text-gray-400 text-sm">
                マウスホイールでズーム、ドラッグで画像を移動できます。<br>
                （モバイルではピンチイン/アウト、スワイプで操作）
            </p>
        </div>

        <!-- 回答パネルのコントローラー -->
        <div class="w-full flex flex-col items-center justify-center mt-auto">
             <div class="flex items-center gap-6 bg-gray-700 rounded-2xl p-6 shadow-lg">
                <div class="text-lg font-semibold text-gray-300">残り時間:</div>
                <div id="timer" class="text-5xl font-bold text-green-400">02:00</div>
                <button id="start-game-btn" class="btn-primary ml-auto">ゲーム開始</button>
                <button id="toggle-answer-btn" class="btn-primary ml-auto hidden" disabled>回答する</button>
             </div>
        </div>

    </div>

    <!-- 回答フォーム (初期状態では非表示) -->
    <div id="answer-form-panel" class="fixed bottom-0 left-0 right-0 lg:left-1/2 lg:right-auto lg:-translate-x-1/2 w-full lg:w-1/3 bg-gray-800 rounded-t-3xl lg:rounded-3xl shadow-2xl p-6 lg:p-8 flex flex-col z-50 transform translate-y-full transition-transform duration-500 ease-in-out">
        <h2 class="text-2xl font-bold mb-4 text-center">回答フォーム</h2>
        
        <div class="mb-6">
            <label for="date-input" class="block text-lg font-semibold mb-2">年月日を記入</label>
            <input type="text" id="date-input" placeholder="例: 1563年7月4日" class="w-full bg-gray-600 text-white p-3 rounded-lg border border-transparent focus:border-blue-500 focus:ring-2 focus:ring-blue-500 transition-all duration-200">
        </div>
        
        <div class="mb-6">
            <p class="text-lg font-semibold mb-2">場所を選択</p>
            <div id="map" class="h-64 rounded-lg"></div>
            <div id="map-instructions" class="text-sm text-gray-400 mt-2 text-center">地図をドラッグして、マーカーを正しい場所に移動してください。</div>
        </div>

        <div class="mb-6">
            <p class="text-lg font-semibold mb-2">ヒントを表示</p>
            <div class="flex items-center gap-4">
                <select id="hint-select" class="flex-grow bg-gray-600 text-white p-3 rounded-lg border border-transparent focus:border-blue-500 focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                    <option value="none">ヒントなし</option>
                    <option value="constellation_lines">星座線</option>
                    <option value="constellation_names">星座名</option>
                    <option value="constellation_art">星座絵</option>
                    <option value="constellation_boundaries">星座の境界線</option>
                    <option value="equatorial_grid">赤経・赤緯</option>
                    <option value="horizontal_grid">方位角・高度</option>
                    <option value="ecliptic_grid">黄経・黄緯</option>
                    <option value="nebulae">星雲・星団</option>
                    <option value="meteor_showers">流星群</option>
                </select>
                <button id="show-hint-btn" class="btn-secondary whitespace-now-wrap px-4 py-2" disabled>適用</button>
            </div>
        </div>

        <button id="submit-answer-btn" class="btn-primary w-full mt-auto" disabled>回答を送信する</button>
        <button id="close-form-btn" class="btn-secondary w-full mt-4">閉じる</button>
    </div>

    <!-- タイムアップ時に表示されるモーダル -->
    <div id="game-over-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-3xl font-bold text-red-500 mb-4">時間切れです！</h3>
            <p class="text-lg text-gray-300">回答を送信できませんでした。</p>
            <button id="modal-close-btn" class="btn-primary mt-6">OK</button>
        </div>
    </div>
    
    <!-- 正解時に表示されるモーダル -->
    <div id="correct-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-3xl font-bold text-green-500 mb-4">正解です！</h3>
            <p class="text-lg text-gray-300 mb-2">素晴らしい！見事に正解を導き出しました。</p>
            <p class="text-gray-400 mb-4">正解: <span id="correct-answer-text"></span></p>
            <button id="correct-modal-close-btn" class="btn-primary mt-6">OK</button>
        </div>
    </div>

    <!-- 不正解時に表示されるモーダル -->
    <div id="incorrect-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-3xl font-bold text-red-500 mb-4">残念、不正解です...</h3>
            <p class="text-lg text-gray-300 mb-2">もう一度挑戦してみましょう！</p>
            <p class="text-gray-400 mb-4">正解は<span id="incorrect-answer-text"></span>でした。</p>
            <button id="incorrect-modal-close-btn" class="btn-primary mt-6">OK</button>
        </div>
    </div>
    
    <!-- Google Maps APIを非同期で読み込む -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLOsp3svpLC8iSyyqlqWjNkFGIOuCb1vw&callback=initMap"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const nightSkyContainer = document.querySelector('.night-sky-container');
            const nightSkyBase = document.getElementById('night-sky-base');
            const nightSkyHint = document.getElementById('night-sky-hint');
            const hintSelect = document.getElementById('hint-select');
            const showHintBtn = document.getElementById('show-hint-btn');
            const timerDisplay = document.getElementById('timer');
            const startGameBtn = document.getElementById('start-game-btn');
            const toggleAnswerBtn = document.getElementById('toggle-answer-btn');
            const answerFormPanel = document.getElementById('answer-form-panel');
            const submitAnswerBtn = document.getElementById('submit-answer-btn');
            const closeFormBtn = document.getElementById('close-form-btn');
            const gameOverModal = document.getElementById('game-over-modal');
            const modalCloseBtn = document = document.getElementById('modal-close-btn');
            const dateInput = document.getElementById('date-input');
            const correctModal = document.getElementById('correct-modal');
            const correctModalCloseBtn = document.getElementById('correct-modal-close-btn');
            const incorrectModal = document.getElementById('incorrect-modal');
            const incorrectModalCloseBtn = document.getElementById('incorrect-modal-close-btn');
            const correctAnswerText = document.getElementById('correct-answer-text');
            const incorrectAnswerText = document.getElementById('incorrect-answer-text');

            let timerInterval = null;
            let timeLeft = 120; // 2分 = 120秒
            let currentEvent = null; // 現在出題されている出来事のデータ
            let map, marker;

            // ゲームの問題データ
            const gameEvents = [
                {
                    id: 'pearl-harbor-attack',
                    name: '真珠湾攻撃',
                    answerDate: '1941年12月7日',
                    correctLocation: { lat: 21.35, lng: -157.95 },
                    imageDir: 'historical-events/1941-12-07_21.35N157.95W_Pearl Harbor Attack',
                },
                {
                    id: 'normandy-invasion',
                    name: 'ノルマンディー上陸作戦',
                    answerDate: '1944年6月6日',
                    correctLocation: { lat: 49.414, lng: -0.831 },
                    imageDir: 'historical-events/1944-06-06_49.414N0.831W_Normandy Invasion',
                },
                {
                    id: 'fall-of-berlin-wall',
                    name: 'ベルリンの壁崩壊',
                    answerDate: '1989年11月9日',
                    correctLocation: { lat: 52.516, lng: 13.377 },
                    imageDir: 'historical-events/1989-11-09_52.516N13.377W_Fall of Berlin Wall',
                }
            ];

            // Googleマップを初期化する
            window.initMap = () => {
                // デフォルトの場所を地図の中心にする
                const defaultPosition = { lat: currentEvent.correctLocation.lat, lng: currentEvent.correctLocation.lng };
                map = new google.maps.Map(document.getElementById("map"), {
                    center: { lat: 0, lng: 0 }, // 世界全体を表示するため、中心を(0,0)に設定
                    zoom: 2,
                    streetViewControl: false,
                    mapTypeControl: false,
                    fullscreenControl: false
                });

                // マーカーを作成し、ドラッグ可能にする
                marker = new google.maps.Marker({
                    position: defaultPosition,
                    map: map,
                    draggable: true,
                });

                // プレイヤーのマーカー位置を追跡する
                marker.addListener("dragend", () => {
                    console.log("Marker dragged to:", marker.getPosition().toJSON());
                });
            };
            
            // ゲーム開始ボタンのクリックイベント
            startGameBtn.addEventListener('click', () => {
                startGame();
            });

            // ゲーム開始ロジック
            function startGame() {
                if (timerInterval) return; // すでにゲームが始まっていたら何もしない

                // ランダムに問題を選ぶ
                const randomIndex = Math.floor(Math.random() * gameEvents.length);
                currentEvent = gameEvents[randomIndex];

                // 画像を更新
                const baseImagePath = `${currentEvent.imageDir}/${currentEvent.imageDir.split('/').pop()}_base.png`;
                nightSkyBase.src = baseImagePath;
                nightSkyHint.src = '';
                
                // フォームとボタンの状態をリセット
                dateInput.value = '';
                hintSelect.value = 'none';
                isFormVisible = false;
                updateFormPanel();
                toggleAnswerBtn.textContent = '回答する';
                
                startGameBtn.classList.add('hidden');
                toggleAnswerBtn.classList.remove('hidden');
                toggleAnswerBtn.disabled = false;
                showHintBtn.disabled = false;
                submitAnswerBtn.disabled = false;

                timeLeft = 120;
                timerDisplay.textContent = "02:00";
                timerDisplay.classList.remove('text-red-500');
                timerDisplay.classList.add('text-green-400');
                
                // 地図を初期化
                if (window.initMap) {
                    initMap();
                } else {
                    console.error("Google Maps API is not loaded yet.");
                }

                // タイムリミットのカウントダウンを開始
                timerInterval = setInterval(() => {
                    timeLeft--;
                    if (timeLeft <= 0) {
                        endGame('timeup');
                        return;
                    }
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }, 1000);
            }

            // ゲーム終了ロジック（時間切れまたは回答送信時）
            function endGame(result) {
                clearInterval(timerInterval);
                timerInterval = null;
                toggleAnswerBtn.disabled = true;
                submitAnswerBtn.disabled = true;
                showHintBtn.disabled = true;
                
                if (result === 'correct') {
                    correctAnswerText.textContent = `${currentEvent.answerDate}, ${currentEvent.name}`;
                    correctModal.classList.add('visible');
                } else if (result === 'incorrect') {
                    incorrectAnswerText.textContent = `${currentEvent.answerDate}, ${currentEvent.name}`;
                    incorrectModal.classList.add('visible');
                } else if (result === 'timeup') {
                    gameOverModal.classList.add('visible');
                }
            }
            
            // --- 2地点間の距離を計算する関数 (ヒュベニの公式) ---
            function haversineDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // 地球の半径（km）
                const toRadians = (deg) => deg * (Math.PI / 180);
                const dLat = toRadians(lat2 - lat1);
                const dLon = toRadians(lon2 - lon1);
                const a = 
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c; // km
            }

            // --- モーダルの表示/非表示 ---
            modalCloseBtn.addEventListener('click', () => {
                gameOverModal.classList.remove('visible');
            });
            correctModalCloseBtn.addEventListener('click', () => {
                correctModal.classList.remove('visible');
            });
            incorrectModalCloseBtn.addEventListener('click', () => {
                incorrectModal.classList.remove('visible');
            });

            // --- 回答フォームの表示/非表示 ---
            let isFormVisible = false;

            const updateFormPanel = () => {
                if (isFormVisible) {
                    answerFormPanel.style.transform = 'translateY(0)';
                } else {
                    answerFormPanel.style.transform = 'translateY(100%)';
                }
            };

            toggleAnswerBtn.addEventListener('click', () => {
                isFormVisible = !isFormVisible;
                updateFormPanel();
                if (isFormVisible) {
                    toggleAnswerBtn.textContent = '閉じる';
                } else {
                    toggleAnswerBtn.textContent = '回答する';
                }
            });

            closeFormBtn.addEventListener('click', () => {
                isFormVisible = false;
                updateFormPanel();
                toggleAnswerBtn.textContent = '回答する';
            });

            // --- 画像のズームとドラッグ機能 ---
            let zoom = 1;
            const maxZoom = 4;
            const minZoom = 1;
            let isDragging = false;
            let startX, startY;
            let currentX = 0, currentY = 0;
            let offsetX = 0, offsetY = 0;

            nightSkyContainer.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                let newZoom = zoom + delta;
                newZoom = Math.max(minZoom, Math.min(maxZoom, newZoom));
                
                const rect = nightSkyContainer.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                offsetX += ((mouseX / rect.width) * (newZoom - zoom)) * nightSkyBase.offsetWidth;
                offsetY += ((mouseY / rect.height) * (newZoom - zoom)) * nightSkyBase.offsetHeight;
                zoom = newZoom;
                updateTransform();
            });

            nightSkyContainer.addEventListener('mousedown', (e) => {
                isDragging = true;
                nightSkyBase.style.cursor = 'grabbing';
                nightSkyHint.style.cursor = 'grabbing';
                startX = e.clientX - offsetX;
                startY = e.clientY - offsetY;
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                nightSkyBase.style.cursor = 'grab';
                nightSkyHint.style.cursor = 'grab';
                offsetX = currentX;
                offsetY = currentY;
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                currentX = e.clientX - startX;
                currentY = e.clientY - startY;
                const boundaryX = (nightSkyBase.offsetWidth * zoom - nightSkyContainer.offsetWidth) / 2;
                const boundaryY = (nightSkyBase.offsetHeight * zoom - nightSkyContainer.offsetHeight) / 2;
                currentX = Math.max(-boundaryX, Math.min(boundaryX, currentX));
                currentY = Math.max(-boundaryY, Math.min(boundaryY, currentY));
                updateTransform();
            });
            
            let lastDistance = null;
            nightSkyContainer.addEventListener('touchstart', (e) => {
                isDragging = false;
                lastDistance = null;
                if (e.touches.length === 1) {
                    isDragging = true;
                    startX = e.touches[0].clientX - offsetX;
                    startY = e.touches[0].clientY - offsetY;
                } else if (e.touches.length === 2) {
                    lastDistance = getDistance(e.touches[0], e.touches[1]);
                    isDragging = false;
                }
            }, { passive: false });

            nightSkyContainer.addEventListener('touchend', (e) => {
                isDragging = false;
                offsetX = currentX;
                offsetY = currentY;
            });

            nightSkyContainer.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length === 1 && isDragging) {
                    currentX = e.touches[0].clientX - startX;
                    currentY = e.touches[0].clientY - startY;
                    const boundaryX = (nightSkyBase.offsetWidth * zoom - nightSkyContainer.offsetWidth) / 2;
                    const boundaryY = (nightSkyBase.offsetHeight * zoom - nightSkyContainer.offsetHeight) / 2;
                    currentX = Math.max(-boundaryX, Math.min(boundaryX, currentX));
                    currentY = Math.max(-boundaryY, Math.min(boundaryY, currentY));
                    updateTransform();
                } else if (e.touches.length === 2 && lastDistance) {
                    const newDistance = getDistance(e.touches[0], e.touches[1]);
                    const delta = (newDistance - lastDistance) / 1000;
                    let newZoom = zoom + delta;
                    newZoom = Math.max(minZoom, Math.min(maxZoom, newZoom));
                    const touchCenter = getCenter(e.touches[0], e.touches[1]);
                    const rect = nightSkyContainer.getBoundingClientRect();
                    const touchX = touchCenter.x - rect.left;
                    const touchY = touchCenter.y - rect.top;
                    offsetX += ((touchX / rect.width) * (newZoom - zoom)) * nightSkyBase.offsetWidth;
                    offsetY += ((touchY / rect.height) * (newZoom - zoom)) * nightSkyBase.offsetHeight;
                    zoom = newZoom;
                    lastDistance = newDistance;
                    updateTransform();
                }
            }, { passive: false });

            function updateTransform() {
                const transform = `scale(${zoom}) translate(${currentX}px, ${currentY}px)`;
                nightSkyBase.style.transform = transform;
                nightSkyHint.style.transform = transform;
            }

            function getDistance(touch1, touch2) {
                return Math.sqrt(Math.pow(touch2.clientX - touch1.clientX, 2) + Math.pow(touch2.clientY - touch1.clientY, 2));
            }

            function getCenter(touch1, touch2) {
                return {
                    x: (touch1.clientX + touch2.clientX) / 2,
                    y: (touch1.clientY + touch2.clientY) / 2
                };
            }

            // ヒントのキーとファイル名のマッピング
            const hintFileNames = {
                "constellation_lines": "_hint_constellation_lines.png",
                "constellation_names": "_hint_constellation_names.png",
                "constellation_art": "_hint_constellation_art.png",
                "constellation_boundaries": "_hint_constellation_boundaries.png",
                "equatorial_grid": "_hint_equatorial_grid.png",
                "horizontal_grid": "_hint_azimuthal_grid.png",
                "ecliptic_grid": "_hint_ecliptic_grid.png",
                "nebulae": "_hint_nebulae.png",
                "meteor_showers": "_hint_meteor_showers.png"
            };

            // --- ヒント表示機能 ---
            showHintBtn.addEventListener('click', () => {
                const selectedHint = hintSelect.value;
                if (selectedHint === "none") {
                    nightSkyHint.classList.remove('active');
                } else {
                    const hintPath = `${currentEvent.imageDir}/${currentEvent.imageDir.split('/').pop()}${hintFileNames[selectedHint]}`;
                    nightSkyHint.src = hintPath;
                    nightSkyHint.classList.add('active');
                }
            });

            // --- 回答ボタン ---
            submitAnswerBtn.addEventListener('click', () => {
                const userAnswerDate = dateInput.value.trim();
                const correctAnswerDate = currentEvent.answerDate;
                const isDateCorrect = userAnswerDate === correctAnswerDate;

                const userPosition = marker.getPosition();
                const correctPosition = currentEvent.correctLocation;
                const distance = haversineDistance(userPosition.lat(), userPosition.lng(), correctPosition.lat, correctPosition.lng);

                // 許容範囲を500kmに設定
                const isLocationCorrect = distance < 500; 

                if (isDateCorrect && isLocationCorrect) {
                    endGame('correct');
                } else {
                    endGame('incorrect');
                }
            });
        });
    </script>

</body>
</html>
